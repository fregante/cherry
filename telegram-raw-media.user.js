// ==UserScript==
// @name         Telegram Raw Media
// @version      2
// @description  Show media on t.me as regular elements
// @author       kidonng
// @namespace    https://github.com/kidonng/cherry
// @match        https://t.me/*
// @match        https://telegram.me/*
// @example      https://t.me/kichann/1281
// ==/UserScript==
(()=>{var X=["a","altGlyph","altGlyphDef","altGlyphItem","animate","animateColor","animateMotion","animateTransform","animation","audio","canvas","circle","clipPath","color-profile","cursor","defs","desc","discard","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","font","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignObject","g","glyph","glyphRef","handler","hkern","iframe","image","line","linearGradient","listener","marker","mask","metadata","missing-glyph","mpath","path","pattern","polygon","polyline","prefetch","radialGradient","rect","script","set","solidColor","stop","style","svg","switch","symbol","tbreak","text","textArea","textPath","title","tref","tspan","unknown","use","video","view","vkern"],p=new Set(X);p.delete("a");p.delete("audio");p.delete("canvas");p.delete("iframe");p.delete("script");p.delete("video");var Y=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,Z=e=>e===DocumentFragment,z=(e,n)=>{for(let[t,i]of Object.entries(n))t.startsWith("-")?e.style.setProperty(t,i):typeof i=="number"&&!Y.test(t)?e.style[t]=`${i}px`:e.style[t]=i},ee=e=>typeof e=="string"?p.has(e)?document.createElementNS("http://www.w3.org/2000/svg",e):document.createElement(e):Z(e)?document.createDocumentFragment():e(e.defaultProps),R=(e,n,t)=>{t!=null&&(/^xlink[AHRST]/.test(n)?e.setAttributeNS("http://www.w3.org/1999/xlink",n.replace("xlink","xlink:").toLowerCase(),t):e.setAttribute(n,t))},q=(e,n)=>{for(let t of n)t instanceof Node?e.appendChild(t):Array.isArray(t)?q(e,t):typeof t!="boolean"&&typeof t<"u"&&t!==null&&e.appendChild(document.createTextNode(t))},te=(e,n,...t)=>{var i;let r=ee(e);if(q(r,t),r instanceof DocumentFragment||!n)return r;for(let[o,a]of Object.entries(n))if(o==="htmlFor"&&(o="for"),o==="class"||o==="className"){let s=(i=r.getAttribute("class"))!==null&&i!==void 0?i:"";R(r,"class",(s+" "+String(a)).trim())}else if(o==="style")z(r,a);else if(o.startsWith("on")){let s=o.slice(2).toLowerCase().replace(/^-/,"");r.addEventListener(s,a)}else o==="dangerouslySetInnerHTML"&&"__html"in a?r.innerHTML=a.__html:o!=="key"&&a!==!1&&R(r,o,a===!0?"":a);return r},ne=typeof DocumentFragment=="function"?DocumentFragment:()=>{},re={createElement:te,Fragment:ne},g=re;function d(){if(!(this instanceof d))return new d;this.size=0,this.uid=0,this.selectors=[],this.selectorObjects={},this.indexes=Object.create(this.indexes),this.activeIndexes=[]}var y=window.document.documentElement,ie=y.matches||y.webkitMatchesSelector||y.mozMatchesSelector||y.oMatchesSelector||y.msMatchesSelector;d.prototype.matchesSelector=function(e,n){return ie.call(e,n)};d.prototype.querySelectorAll=function(e,n){return n.querySelectorAll(e)};d.prototype.indexes=[];var oe=/^#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;d.prototype.indexes.push({name:"ID",selector:function(n){var t;if(t=n.match(oe))return t[0].slice(1)},element:function(n){if(n.id)return[n.id]}});var ae=/^\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;d.prototype.indexes.push({name:"CLASS",selector:function(n){var t;if(t=n.match(ae))return t[0].slice(1)},element:function(n){var t=n.className;if(t){if(typeof t=="string")return t.split(/\s/);if(typeof t=="object"&&"baseVal"in t)return t.baseVal.split(/\s/)}}});var se=/^((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;d.prototype.indexes.push({name:"TAG",selector:function(n){var t;if(t=n.match(se))return t[0].toUpperCase()},element:function(n){return[n.nodeName.toUpperCase()]}});d.prototype.indexes.default={name:"UNIVERSAL",selector:function(){return!0},element:function(){return[!0]}};var N;typeof window.Map=="function"?N=window.Map:N=function(){function e(){this.map={}}return e.prototype.get=function(n){return this.map[n+" "]},e.prototype.set=function(n,t){this.map[n+" "]=t},e}();var P=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g;function j(e,n){e=e.slice(0).concat(e.default);var t=e.length,i,r,o,a,s=n,l,f,c=[];do if(P.exec(""),(o=P.exec(s))&&(s=o[3],o[2]||!s)){for(i=0;i<t;i++)if(f=e[i],l=f.selector(o[1])){for(r=c.length,a=!1;r--;)if(c[r].index===f&&c[r].key===l){a=!0;break}a||c.push({index:f,key:l});break}}while(o);return c}function le(e,n){var t,i,r;for(t=0,i=e.length;t<i;t++)if(r=e[t],n.isPrototypeOf(r))return r}d.prototype.logDefaultIndexUsed=function(){};d.prototype.add=function(e,n){var t,i,r,o,a,s,l,f,c=this.activeIndexes,u=this.selectors,h=this.selectorObjects;if(typeof e=="string"){for(t={id:this.uid++,selector:e,data:n},h[t.id]=t,l=j(this.indexes,e),i=0;i<l.length;i++)f=l[i],o=f.key,r=f.index,a=le(c,r),a||(a=Object.create(r),a.map=new N,c.push(a)),r===this.indexes.default&&this.logDefaultIndexUsed(t),s=a.map.get(o),s||(s=[],a.map.set(o,s)),s.push(t);this.size++,u.push(e)}};d.prototype.remove=function(e,n){if(typeof e=="string"){var t,i,r,o,a,s,l,f,c=this.activeIndexes,u=this.selectors=[],h=this.selectorObjects,m={},S=arguments.length===1;for(t=j(this.indexes,e),r=0;r<t.length;r++)for(i=t[r],o=c.length;o--;)if(s=c[o],i.index.isPrototypeOf(s)){if(l=s.map.get(i.key),l)for(a=l.length;a--;)f=l[a],f.selector===e&&(S||f.data===n)&&(l.splice(a,1),m[f.id]=!0);break}for(r in m)delete h[r],this.size--;for(r in h)u.push(h[r].selector)}};function B(e,n){return e.id-n.id}d.prototype.queryAll=function(e){if(!this.selectors.length)return[];var n={},t=[],i=this.querySelectorAll(this.selectors.join(", "),e),r,o,a,s,l,f,c,u;for(r=0,a=i.length;r<a;r++)for(l=i[r],f=this.matches(l),o=0,s=f.length;o<s;o++)u=f[o],n[u.id]?c=n[u.id]:(c={id:u.id,selector:u.selector,data:u.data,elements:[]},n[u.id]=c,t.push(c)),c.elements.push(l);return t.sort(B)};d.prototype.matches=function(e){if(!e)return[];var n,t,i,r,o,a,s,l,f,c,u,h=this.activeIndexes,m={},S=[];for(n=0,r=h.length;n<r;n++)if(s=h[n],l=s.element(e),l){for(t=0,o=l.length;t<o;t++)if(f=s.map.get(l[t]))for(i=0,a=f.length;i<a;i++)c=f[i],u=c.id,!m[u]&&this.matchesSelector(e,c.selector)&&(m[u]=!0,S.push(c))}return S.sort(B)};var G=d;var M=null,D=null,L=[];function H(e,n){var t=[];function i(){var o=t;t=[],n(o)}function r(){for(var o=arguments.length,a=Array(o),s=0;s<o;s++)a[s]=arguments[s];t.push(a),t.length===1&&T(e,i)}return r}function T(e,n){D||(D=new MutationObserver(ce)),M||(M=e.createElement("div"),D.observe(M,{attributes:!0})),L.push(n),M.setAttribute("data-twiddle",""+Date.now())}function ce(){var e=L;L=[];for(var n=0;n<e.length;n++)try{e[n]()}catch(t){setTimeout(function(){throw t},0)}}var $=new WeakMap,w=new WeakMap,b=new WeakMap,v=new WeakMap;function I(e,n){for(var t=0;t<n.length;t++){var i=n[t],r=i[0],o=i[1],a=i[2];r===A?(fe(a,o),ue(a,o)):r===V?W(a,o):r===k&&de(e.observers,o)}}function fe(e,n){if(n instanceof e.elementConstructor){var t=$.get(n);if(t||(t=[],$.set(n,t)),t.indexOf(e.id)===-1){var i=void 0;if(e.initialize&&(i=e.initialize.call(void 0,n)),i){var r=w.get(n);r||(r={},w.set(n,r)),r[""+e.id]=i}t.push(e.id)}}}function ue(e,n){if(n instanceof e.elementConstructor){var t=v.get(n);if(t||(t=[],v.set(n,t)),t.indexOf(e.id)===-1){e.elements.push(n);var i=w.get(n),r=i?i[""+e.id]:null;if(r&&r.add&&r.add.call(void 0,n),e.subscribe){var o=e.subscribe.call(void 0,n);if(o){var a=b.get(n);a||(a={},b.set(n,a)),a[""+e.id]=o}}e.add&&e.add.call(void 0,n),t.push(e.id)}}}function W(e,n){if(n instanceof e.elementConstructor){var t=v.get(n);if(!!t){var i=e.elements.indexOf(n);if(i!==-1&&e.elements.splice(i,1),i=t.indexOf(e.id),i!==-1){var r=w.get(n),o=r?r[""+e.id]:null;if(o&&o.remove&&o.remove.call(void 0,n),e.subscribe){var a=b.get(n),s=a?a[""+e.id]:null;s&&s.unsubscribe&&s.unsubscribe()}e.remove&&e.remove.call(void 0,n),t.splice(i,1)}t.length===0&&v.delete(n)}}}function de(e,n){var t=v.get(n);if(!!t){for(var i=t.slice(0),r=0;r<i.length;r++){var o=e[i[r]];if(!!o){var a=o.elements.indexOf(n);a!==-1&&o.elements.splice(a,1);var s=w.get(n),l=s?s[""+o.id]:null;l&&l.remove&&l.remove.call(void 0,n);var f=b.get(n),c=f?f[""+o.id]:null;c&&c.unsubscribe&&c.unsubscribe(),o.remove&&o.remove.call(void 0,n)}}v.delete(n)}}var O=null;function he(e){if(O===null){var n=e.createElement("div"),t=e.createElement("div"),i=e.createElement("div");n.appendChild(t),t.appendChild(i),n.innerHTML="",O=i.parentNode!==t}return O}function U(e){return"matches"in e||"webkitMatchesSelector"in e||"mozMatchesSelector"in e||"oMatchesSelector"in e||"msMatchesSelector"in e}var A=1,V=2,k=3;function me(e,n,t){for(var i=0;i<t.length;i++){var r=t[i];r.type==="childList"?(Q(e,n,r.addedNodes),pe(e,n,r.removedNodes)):r.type==="attributes"&&C(e,n,r.target)}he(e.ownerDocument)&&ye(e,n)}function Q(e,n,t){for(var i=0;i<t.length;i++){var r=t[i];if(U(r))for(var o=e.selectorSet.matches(r),a=0;a<o.length;a++){var s=o[a].data;n.push([A,r,s])}if("querySelectorAll"in r)for(var l=e.selectorSet.queryAll(r),f=0;f<l.length;f++)for(var c=l[f],u=c.data,h=c.elements,m=0;m<h.length;m++)n.push([A,h[m],u])}}function pe(e,n,t){for(var i=0;i<t.length;i++){var r=t[i];if("querySelectorAll"in r){n.push([k,r]);for(var o=r.querySelectorAll("*"),a=0;a<o.length;a++)n.push([k,o[a]])}}}function C(e,n,t){if(U(t))for(var i=e.selectorSet.matches(t),r=0;r<i.length;r++){var o=i[r].data;n.push([A,t,o])}if("querySelectorAll"in t){var a=v.get(t);if(a)for(var s=0;s<a.length;s++){var l=e.observers[a[s]];l&&(e.selectorSet.matchesSelector(t,l.selector)||n.push([V,t,l]))}}}function ve(e,n,t){if("querySelectorAll"in t){C(e,n,t);for(var i=t.querySelectorAll("*"),r=0;r<i.length;r++)C(e,n,i[r])}}function ge(e,n,t){for(var i=0;i<t.length;i++)for(var r=t[i],o=r.form?r.form.elements:e.rootNode.querySelectorAll("input"),a=0;a<o.length;a++)C(e,n,o[a])}function ye(e,n){for(var t=0;t<e.observers.length;t++){var i=e.observers[t];if(i)for(var r=i.elements,o=0;o<r.length;o++){var a=r[o];a.parentNode||n.push([k,a])}}}function we(e,n){var t=e.readyState;t==="interactive"||t==="complete"?T(e,n):e.addEventListener("DOMContentLoaded",T(e,n))}var xe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Se=0;function x(e){this.rootNode=e.nodeType===9?e.documentElement:e,this.ownerDocument=e.nodeType===9?e:e.ownerDocument,this.observers=[],this.selectorSet=new G,this.mutationObserver=new MutationObserver(Ae.bind(this,this)),this._scheduleAddRootNodes=H(this.ownerDocument,be.bind(this,this)),this._handleThrottledChangedTargets=H(this.ownerDocument,Ce.bind(this,this)),this.rootNode.addEventListener("change",ke.bind(this,this),!1),we(this.ownerDocument,Me.bind(this,this))}x.prototype.disconnect=function(){this.mutationObserver.disconnect()};x.prototype.observe=function(e,n){var t=void 0;typeof n=="function"?t={selector:e,initialize:n}:(typeof n>"u"?"undefined":xe(n))==="object"?(t=n,t.selector=e):t=e;var i=this,r={id:Se++,selector:t.selector,initialize:t.initialize,add:t.add,remove:t.remove,subscribe:t.subscribe,elements:[],elementConstructor:t.hasOwnProperty("constructor")?t.constructor:this.ownerDocument.defaultView.Element,abort:function(){i._abortObserving(r)}};return this.selectorSet.add(r.selector,r),this.observers[r.id]=r,this._scheduleAddRootNodes(),r};x.prototype._abortObserving=function(e){for(var n=e.elements,t=0;t<n.length;t++)W(e,n[t]);this.selectorSet.remove(e.selector,e),delete this.observers[e.id]};x.prototype.triggerObservers=function(e){var n=[];ve(this,n,e),I(this,n)};function Me(e){e.mutationObserver.observe(e.rootNode,{childList:!0,attributes:!0,subtree:!0}),e._scheduleAddRootNodes()}function be(e){var n=[];Q(e,n,[e.rootNode]),I(e,n)}function Ae(e,n){var t=[];me(e,t,n),I(e,t)}function ke(e,n){e._handleThrottledChangedTargets(n.target)}function Ce(e,n){var t=[];ge(e,t,n),I(e,t)}var E=void 0;function Ie(){return E||(E=new x(window.document)),E}function _(){var e;return(e=Ie()).observe.apply(e,arguments)}var Ne=e=>e.style.backgroundImage.replace(/^url\("(.+)"\)$/,"$1"),F=".link_preview_right_image, .tgme_widget_message_reply_thumb",J=`.link_preview_image, ${F}`,K="trm-processed";document.head.append(g.createElement("style",null,`
/* Remove the cover on videos */
.link_preview_video_player:after {
    display: none;
}

/* Fix thumb size */
${F} {
    object-fit: cover;
}
`));_(`:is(.tgme_widget_message_photo, ${J}):not(.${K})`,{add(e){let n=e.matches(J)?e:e.closest(".tgme_widget_message_photo_wrap");if(!n)return;let t=g.createElement("img",{className:e.className,src:Ne(n)});t.classList.add(K),e.matches(F)||(t.style.width="100%"),e.replaceWith(t)}});})();
