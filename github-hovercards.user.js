// ==UserScript==
// @name         GitHub Hovercards
// @version      20
// @description  Enable native hovercards for more GitHub links
// @author       kidonng
// @namespace    https://github.com/kidonng/cherry
// @match        https://github.com/*
// @example      https://github.com/npm/npm
// ==/UserScript==
(()=>{function h(){if(!(this instanceof h))return new h;this.size=0,this.uid=0,this.selectors=[],this.selectorObjects={},this.indexes=Object.create(this.indexes),this.activeIndexes=[]}var w=window.document.documentElement,ot=w.matches||w.webkitMatchesSelector||w.mozMatchesSelector||w.oMatchesSelector||w.msMatchesSelector;h.prototype.matchesSelector=function(t,e){return ot.call(t,e)};h.prototype.querySelectorAll=function(t,e){return e.querySelectorAll(t)};h.prototype.indexes=[];var st=/^#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;h.prototype.indexes.push({name:"ID",selector:function(e){var o;if(o=e.match(st))return o[0].slice(1)},element:function(e){if(e.id)return[e.id]}});var nt=/^\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;h.prototype.indexes.push({name:"CLASS",selector:function(e){var o;if(o=e.match(nt))return o[0].slice(1)},element:function(e){var o=e.className;if(o){if(typeof o=="string")return o.split(/\s/);if(typeof o=="object"&&"baseVal"in o)return o.baseVal.split(/\s/)}}});var it=/^((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;h.prototype.indexes.push({name:"TAG",selector:function(e){var o;if(o=e.match(it))return o[0].toUpperCase()},element:function(e){return[e.nodeName.toUpperCase()]}});h.prototype.indexes.default={name:"UNIVERSAL",selector:function(){return!0},element:function(){return[!0]}};var L;typeof window.Map=="function"?L=window.Map:L=function(){function t(){this.map={}}return t.prototype.get=function(e){return this.map[e+" "]},t.prototype.set=function(e,o){this.map[e+" "]=o},t}();var N=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g;function F(t,e){t=t.slice(0).concat(t.default);var o=t.length,n,s,i,a,r=e,c,d,l=[];do if(N.exec(""),(i=N.exec(r))&&(r=i[3],i[2]||!r)){for(n=0;n<o;n++)if(d=t[n],c=d.selector(i[1])){for(s=l.length,a=!1;s--;)if(l[s].index===d&&l[s].key===c){a=!0;break}a||l.push({index:d,key:c});break}}while(i);return l}function at(t,e){var o,n,s;for(o=0,n=t.length;o<n;o++)if(s=t[o],e.isPrototypeOf(s))return s}h.prototype.logDefaultIndexUsed=function(){};h.prototype.add=function(t,e){var o,n,s,i,a,r,c,d,l=this.activeIndexes,u=this.selectors,p=this.selectorObjects;if(typeof t=="string"){for(o={id:this.uid++,selector:t,data:e},p[o.id]=o,c=F(this.indexes,t),n=0;n<c.length;n++)d=c[n],i=d.key,s=d.index,a=at(l,s),a||(a=Object.create(s),a.map=new L,l.push(a)),s===this.indexes.default&&this.logDefaultIndexUsed(o),r=a.map.get(i),r||(r=[],a.map.set(i,r)),r.push(o);this.size++,u.push(t)}};h.prototype.remove=function(t,e){if(typeof t=="string"){var o,n,s,i,a,r,c,d,l=this.activeIndexes,u=this.selectors=[],p=this.selectorObjects,v={},R=arguments.length===1;for(o=F(this.indexes,t),s=0;s<o.length;s++)for(n=o[s],i=l.length;i--;)if(r=l[i],n.index.isPrototypeOf(r)){if(c=r.map.get(n.key),c)for(a=c.length;a--;)d=c[a],d.selector===t&&(R||d.data===e)&&(c.splice(a,1),v[d.id]=!0);break}for(s in v)delete p[s],this.size--;for(s in p)u.push(p[s].selector)}};function j(t,e){return t.id-e.id}h.prototype.queryAll=function(t){if(!this.selectors.length)return[];var e={},o=[],n=this.querySelectorAll(this.selectors.join(", "),t),s,i,a,r,c,d,l,u;for(s=0,a=n.length;s<a;s++)for(c=n[s],d=this.matches(c),i=0,r=d.length;i<r;i++)u=d[i],e[u.id]?l=e[u.id]:(l={id:u.id,selector:u.selector,data:u.data,elements:[]},e[u.id]=l,o.push(l)),l.elements.push(c);return o.sort(j)};h.prototype.matches=function(t){if(!t)return[];var e,o,n,s,i,a,r,c,d,l,u,p=this.activeIndexes,v={},R=[];for(e=0,s=p.length;e<s;e++)if(r=p[e],c=r.element(t),c){for(o=0,i=c.length;o<i;o++)if(d=r.map.get(c[o]))for(n=0,a=d.length;n<a;n++)l=d[n],u=l.id,!v[u]&&this.matchesSelector(t,l.selector)&&(v[u]=!0,R.push(l))}return R.sort(j)};var $=h;var S=null,O=null,T=[];function q(t,e){var o=[];function n(){var i=o;o=[],e(i)}function s(){for(var i=arguments.length,a=Array(i),r=0;r<i;r++)a[r]=arguments[r];o.push(a),o.length===1&&k(t,n)}return s}function k(t,e){O||(O=new MutationObserver(rt)),S||(S=t.createElement("div"),O.observe(S,{attributes:!0})),T.push(e),S.setAttribute("data-twiddle",""+Date.now())}function rt(){var t=T;T=[];for(var e=0;e<t.length;e++)try{t[e]()}catch(o){setTimeout(function(){throw o},0)}}var H=new WeakMap,y=new WeakMap,x=new WeakMap,f=new WeakMap;function C(t,e){for(var o=0;o<e.length;o++){var n=e[o],s=n[0],i=n[1],a=n[2];s===_?(ct(a,i),lt(a,i)):s===V?G(a,i):s===P&&dt(t.observers,i)}}function ct(t,e){if(e instanceof t.elementConstructor){var o=H.get(e);if(o||(o=[],H.set(e,o)),o.indexOf(t.id)===-1){var n=void 0;if(t.initialize&&(n=t.initialize.call(void 0,e)),n){var s=y.get(e);s||(s={},y.set(e,s)),s[""+t.id]=n}o.push(t.id)}}}function lt(t,e){if(e instanceof t.elementConstructor){var o=f.get(e);if(o||(o=[],f.set(e,o)),o.indexOf(t.id)===-1){t.elements.push(e);var n=y.get(e),s=n?n[""+t.id]:null;if(s&&s.add&&s.add.call(void 0,e),t.subscribe){var i=t.subscribe.call(void 0,e);if(i){var a=x.get(e);a||(a={},x.set(e,a)),a[""+t.id]=i}}t.add&&t.add.call(void 0,e),o.push(t.id)}}}function G(t,e){if(e instanceof t.elementConstructor){var o=f.get(e);if(!!o){var n=t.elements.indexOf(e);if(n!==-1&&t.elements.splice(n,1),n=o.indexOf(t.id),n!==-1){var s=y.get(e),i=s?s[""+t.id]:null;if(i&&i.remove&&i.remove.call(void 0,e),t.subscribe){var a=x.get(e),r=a?a[""+t.id]:null;r&&r.unsubscribe&&r.unsubscribe()}t.remove&&t.remove.call(void 0,e),o.splice(n,1)}o.length===0&&f.delete(e)}}}function dt(t,e){var o=f.get(e);if(!!o){for(var n=o.slice(0),s=0;s<n.length;s++){var i=t[n[s]];if(!!i){var a=i.elements.indexOf(e);a!==-1&&i.elements.splice(a,1);var r=y.get(e),c=r?r[""+i.id]:null;c&&c.remove&&c.remove.call(void 0,e);var d=x.get(e),l=d?d[""+i.id]:null;l&&l.unsubscribe&&l.unsubscribe(),i.remove&&i.remove.call(void 0,e)}}f.delete(e)}}var W=null;function ut(t){if(W===null){var e=t.createElement("div"),o=t.createElement("div"),n=t.createElement("div");e.appendChild(o),o.appendChild(n),e.innerHTML="",W=n.parentNode!==o}return W}function z(t){return"matches"in t||"webkitMatchesSelector"in t||"mozMatchesSelector"in t||"oMatchesSelector"in t||"msMatchesSelector"in t}var _=1,V=2,P=3;function ht(t,e,o){for(var n=0;n<o.length;n++){var s=o[n];s.type==="childList"?(Q(t,e,s.addedNodes),pt(t,e,s.removedNodes)):s.type==="attributes"&&E(t,e,s.target)}ut(t.ownerDocument)&&ft(t,e)}function Q(t,e,o){for(var n=0;n<o.length;n++){var s=o[n];if(z(s))for(var i=t.selectorSet.matches(s),a=0;a<i.length;a++){var r=i[a].data;e.push([_,s,r])}if("querySelectorAll"in s)for(var c=t.selectorSet.queryAll(s),d=0;d<c.length;d++)for(var l=c[d],u=l.data,p=l.elements,v=0;v<p.length;v++)e.push([_,p[v],u])}}function pt(t,e,o){for(var n=0;n<o.length;n++){var s=o[n];if("querySelectorAll"in s){e.push([P,s]);for(var i=s.querySelectorAll("*"),a=0;a<i.length;a++)e.push([P,i[a]])}}}function E(t,e,o){if(z(o))for(var n=t.selectorSet.matches(o),s=0;s<n.length;s++){var i=n[s].data;e.push([_,o,i])}if("querySelectorAll"in o){var a=f.get(o);if(a)for(var r=0;r<a.length;r++){var c=t.observers[a[r]];c&&(t.selectorSet.matchesSelector(o,c.selector)||e.push([V,o,c]))}}}function vt(t,e,o){if("querySelectorAll"in o){E(t,e,o);for(var n=o.querySelectorAll("*"),s=0;s<n.length;s++)E(t,e,n[s])}}function mt(t,e,o){for(var n=0;n<o.length;n++)for(var s=o[n],i=s.form?s.form.elements:t.rootNode.querySelectorAll("input"),a=0;a<i.length;a++)E(t,e,i[a])}function ft(t,e){for(var o=0;o<t.observers.length;o++){var n=t.observers[o];if(n)for(var s=n.elements,i=0;i<s.length;i++){var a=s[i];a.parentNode||e.push([P,a])}}}function gt(t,e){var o=t.readyState;o==="interactive"||o==="complete"?k(t,e):t.addEventListener("DOMContentLoaded",k(t,e))}var wt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},yt=0;function b(t){this.rootNode=t.nodeType===9?t.documentElement:t,this.ownerDocument=t.nodeType===9?t:t.ownerDocument,this.observers=[],this.selectorSet=new $,this.mutationObserver=new MutationObserver(St.bind(this,this)),this._scheduleAddRootNodes=q(this.ownerDocument,Rt.bind(this,this)),this._handleThrottledChangedTargets=q(this.ownerDocument,_t.bind(this,this)),this.rootNode.addEventListener("change",xt.bind(this,this),!1),gt(this.ownerDocument,bt.bind(this,this))}b.prototype.disconnect=function(){this.mutationObserver.disconnect()};b.prototype.observe=function(t,e){var o=void 0;typeof e=="function"?o={selector:t,initialize:e}:(typeof e>"u"?"undefined":wt(e))==="object"?(o=e,o.selector=t):o=t;var n=this,s={id:yt++,selector:o.selector,initialize:o.initialize,add:o.add,remove:o.remove,subscribe:o.subscribe,elements:[],elementConstructor:o.hasOwnProperty("constructor")?o.constructor:this.ownerDocument.defaultView.Element,abort:function(){n._abortObserving(s)}};return this.selectorSet.add(s.selector,s),this.observers[s.id]=s,this._scheduleAddRootNodes(),s};b.prototype._abortObserving=function(t){for(var e=t.elements,o=0;o<e.length;o++)G(t,e[o]);this.selectorSet.remove(t.selector,t),delete this.observers[t.id]};b.prototype.triggerObservers=function(t){var e=[];vt(this,e,t),C(this,e)};function bt(t){t.mutationObserver.observe(t.rootNode,{childList:!0,attributes:!0,subtree:!0}),t._scheduleAddRootNodes()}function Rt(t){var e=[];Q(t,e,[t.rootNode]),C(t,e)}function St(t,e){var o=[];ht(t,o,e),C(t,o)}function xt(t,e){t._handleThrottledChangedTargets(e.target)}function _t(t,e){var o=[];mt(t,o,e),C(t,o)}var A=void 0;function Pt(){return A||(A=new b(window.document)),A}function I(){var t;return(t=Pt()).observe.apply(t,arguments)}var Y=["400","401","402","403","404","405","406","407","408","409","410","411","412","413","414","415","416","417","418","419","420","421","422","423","424","425","426","427","428","429","430","431","500","501","502","503","504","505","506","507","508","509","510","511","about","access","account","admin","advisories","anonymous","any","api","apps","attributes","auth","billing","blob","blog","bounty","branches","business","businesses","c","cache","case-studies","categories","central","certification","changelog","cla","cloud","codereview","collection","collections","comments","commit","commits","community","companies","compare","contact","contributing","cookbook","coupons","customer-stories","customer","customers","dashboard","dashboards","design","develop","developer","diff","discover","discussions","docs","downloads","downtime","editor","editors","edu","enterprise","events","explore","featured","features","files","fixtures","forked","garage","ghost","gist","gists","graphs","guide","guides","help","help-wanted","home","hooks","hosting","hovercards","identity","images","inbox","individual","info","integration","interfaces","introduction","invalid-email-address","investors","issues","jobs","join","journal","journals","lab","labs","languages","launch","layouts","learn","legal","library","linux","listings","lists","login","logos","logout","mac","maintenance","malware","man","marketplace","mention","mentioned","mentioning","mentions","migrating","milestones","mine","mirrors","mobile","navigation","network","new","news","none","nonprofit","nonprofits","notices","notifications","oauth","offer","open-source","organisations","organizations","orgs","pages","partners","payments","personal","plans","plugins","popular","popularity","posts","press","pricing","professional","projects","pulls","raw","readme","recommendations","redeem","releases","render","reply","repositories","resources","restore","revert","save-net-neutrality","saved","scraping","search","security","services","sessions","settings","shareholders","shop","showcases","signin","signup","site","spam","sponsors","ssh","staff","starred","stars","static","status","statuses","storage","store","stories","styleguide","subscriptions","suggest","suggestion","suggestions","support","suspended","talks","teach","teacher","teachers","teaching","team","teams","ten","terms","timeline","topic","topics","tos","tour","train","training","translations","tree","trending","updates","username","users","visualization","w","watching","wiki","windows","works-with","www0","www1","www2","www3","www4","www5","www6","www7","www8","www9"];var J=(t=location)=>Ot(t)||B(t);var Et=(t=location)=>!K(t)&&/^$|^(orgs\/[^/]+\/)?dashboard(\/|$)/.test(g(t));var K=(t=location)=>t.hostname.startsWith("gist.")||t.pathname.split("/",2)[1]==="gist";var M=(t=location)=>{var e;return/^issues\/\d+/.test((e=m(t))===null||e===void 0?void 0:e.path)&&document.title!=="GitHub \xB7 Where software is built"};var X=(t=location)=>{var e;return/^discussions\/\d+/.test((e=m(t))===null||e===void 0?void 0:e.path)};var U=(t=location)=>{var e;return/^pull\/\d+/.test((e=m(t))===null||e===void 0?void 0:e.path)&&!Ct(t)},Ct=(t=location)=>{var e;return/^pull\/\d+\/conflicts/.test((e=m(t))===null||e===void 0?void 0:e.path)};var B=(t=location)=>{var e;return/^pull\/\d+\/commits\/[\da-f]{5,40}$/.test((e=m(t))===null||e===void 0?void 0:e.path)};var Mt=(t=location)=>/^[^/]+\/[^/]+/.test(g(t))&&!Y.includes(t.pathname.split("/",2)[1])&&!Et(t)&&!K(t)&&!Lt(t)&&!Wt(t);var Z=(t=location)=>{var e;return((e=m(t))===null||e===void 0?void 0:e.path)===""};var Lt=(t=location)=>t.pathname.split("/")[3]==="search";var Ot=(t=location)=>{var e;return/^commit\/[\da-f]{5,40}$/.test((e=m(t))===null||e===void 0?void 0:e.path)};var D=(t=location)=>{let e=g(t);return e.length>0&&!e.includes("/")&&!e.includes(".")&&!Y.includes(e)};var Wt=(t=location)=>Boolean(t.pathname.split("/")[3]==="generate"),At=()=>{var t;return(t=document.querySelector('meta[name="user-login"]'))===null||t===void 0?void 0:t.getAttribute("content")},g=(t=location)=>t.pathname.replace(/\/+/g,"/").slice(1,t.pathname.endsWith("/")?-1:void 0),m=t=>{if(!t){let s=document.querySelector('[property="og:url"]');if(s){let i=new URL(s.content,location.origin);g(i).toLowerCase()===g(location).toLowerCase()&&(t=i)}}if(typeof t=="string"&&(t=new URL(t,location.origin)),!Mt(t))return;let[e,o,...n]=g(t).split("/");return{owner:e,name:o,nameWithOwner:e+"/"+o,path:n.join("/")}},tt={getUsername:At,getCleanPathname:g,getRepositoryInfo:m};var{getUsername:kt,getCleanPathname:et}=tt,It=new MutationObserver(([t])=>{let e=t.target;e.getAttribute("aria-label")==="Hovercard is unavailable"&&(e.removeAttribute("aria-label"),e.classList.remove("tooltipped"),e.dataset.hovercardUrl=e.dataset.hovercardUrl.replace("/users","/orgs"),e.dispatchEvent(new MouseEvent("mouseleave",{relatedTarget:e.parentElement})),setTimeout(()=>e.dispatchEvent(new MouseEvent("mouseover")),100))}),Ut=new MutationObserver(([t])=>{let e=t.target;e.getAttribute("aria-label")==="Hovercard is unavailable"&&(e.setAttribute("aria-label","Loading..."),e.dispatchEvent(new MouseEvent("mouseleave",{relatedTarget:e.parentElement})),fetch(e.href,{method:"HEAD"}).then(({url:o})=>{e.href=o,e.dataset.hovercardUrl=`${o}/hovercard`,e.removeAttribute("aria-label"),e.classList.remove("tooltipped"),setTimeout(()=>e.dispatchEvent(new MouseEvent("mouseover")),100)}))});I(`a:is([href^="/"], [href^="${location.origin}"]):not(${["[data-hovercard-url]","[data-pjax]",".js-pjax-history-navigate",".js-navigation-open",`[data-hydro-click*='"target":"PINNED_REPO"']`,`[data-hydro-click*='"click_context":"REPOSITORY_CARD","click_target":"REPOSITORY"']`,`[data-hydro-click*='"event_type":"search_result.click"'][data-hydro-click*='"model_name":"Repository"']`,'[itemprop="name codeRepository"]'].join()})`,{constructor:HTMLAnchorElement,add(t){let e=et(t);if(!(![Z,M,U,X,J,D].some(o=>o(t))||e.toLowerCase()===et().toLowerCase()||t.closest(".Popover-message"))){if(D(t)){if(e=e.replace(/([\w-]+).*/,"$1"),e===kt())return;e=`users/${e}`,It.observe(t,{attributes:!0})}if(M(t)||U(t)){if(e.endsWith("/linked_closing_reference"))return fetch(t.href,{method:"HEAD"}).then(({url:o})=>{t.href=o,t.dataset.hovercardUrl=`${o}/hovercard`,t.parentElement.classList.remove("tooltipped")});M(t)?Ut.observe(t,{attributes:!0}):e=B(t)?e.replace(/\/pull\/\d+\/commits/,"/commit"):e.replace(/(\/pull\/\d+).*/,"$1")}t.dataset.hovercardUrl=`/${e}/hovercard`}}});})();
