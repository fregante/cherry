// ==UserScript==
// @name         Telegram Raw Media
// @version      1
// @description  Show media on t.me as regular elements
// @author       kidonng
// @namespace    https://github.com/kidonng/cherry
// @match        https://t.me/*
// @match        https://telegram.me/*
// @grant        GM.addStyle
// @example      https://t.me/kichann/1281
// ==/UserScript==
(()=>{var we=Object.create;var W=Object.defineProperty;var Se=Object.getOwnPropertyDescriptor;var xe=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,Me=Object.prototype.hasOwnProperty;var Ae=r=>W(r,"__esModule",{value:!0});var J=(r,s)=>()=>(s||r((s={exports:{}}).exports,s),s.exports);var Oe=(r,s,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let x of xe(s))!Me.call(r,x)&&x!=="default"&&W(r,x,{get:()=>s[x],enumerable:!(d=Se(s,x))||d.enumerable});return r},Ce=r=>Oe(Ae(W(r!=null?we(be(r)):{},"default",r&&r.__esModule&&"default"in r?{get:()=>r.default,enumerable:!0}:{value:r,enumerable:!0})),r);var z=J((U,Z)=>{(function(r,s){typeof define=="function"&&define.amd?define([],s):typeof U=="object"?Z.exports=s():r.SelectorSet=s()})(U,function(){"use strict";function r(){if(!(this instanceof r))return new r;this.size=0,this.uid=0,this.selectors=[],this.selectorObjects={},this.indexes=Object.create(this.indexes),this.activeIndexes=[]}var s=window.document.documentElement,d=s.matches||s.webkitMatchesSelector||s.mozMatchesSelector||s.oMatchesSelector||s.msMatchesSelector;r.prototype.matchesSelector=function(a,l){return d.call(a,l)},r.prototype.querySelectorAll=function(a,l){return l.querySelectorAll(a)},r.prototype.indexes=[];var x=/^#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;r.prototype.indexes.push({name:"ID",selector:function(l){var f;if(f=l.match(x))return f[0].slice(1)},element:function(l){if(l.id)return[l.id]}});var A=/^\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;r.prototype.indexes.push({name:"CLASS",selector:function(l){var f;if(f=l.match(A))return f[0].slice(1)},element:function(l){var f=l.className;if(f){if(typeof f=="string")return f.split(/\s/);if(typeof f=="object"&&"baseVal"in f)return f.baseVal.split(/\s/)}}});var C=/^((?:[\w\u00c0-\uFFFF\-]|\\.)+)/g;r.prototype.indexes.push({name:"TAG",selector:function(l){var f;if(f=l.match(C))return f[0].toUpperCase()},element:function(l){return[l.nodeName.toUpperCase()]}}),r.prototype.indexes.default={name:"UNIVERSAL",selector:function(){return!0},element:function(){return[!0]}};var O;typeof window.Map=="function"?O=window.Map:O=function(){function a(){this.map={}}return a.prototype.get=function(l){return this.map[l+" "]},a.prototype.set=function(l,f){this.map[l+" "]=f},a}();var D=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g;function q(a,l){a=a.slice(0).concat(a.default);var f=a.length,m,h,w,p,S=l,g,v,y=[];do if(D.exec(""),(w=D.exec(S))&&(S=w[3],w[2]||!S)){for(m=0;m<f;m++)if(v=a[m],g=v.selector(w[1])){for(h=y.length,p=!1;h--;)if(y[h].index===v&&y[h].key===g){p=!0;break}p||y.push({index:v,key:g});break}}while(w);return y}function _(a,l){var f,m,h;for(f=0,m=a.length;f<m;f++)if(h=a[f],l.isPrototypeOf(h))return h}r.prototype.logDefaultIndexUsed=function(){},r.prototype.add=function(a,l){var f,m,h,w,p,S,g,v,y=this.activeIndexes,b=this.selectors,I=this.selectorObjects;if(typeof a=="string"){for(f={id:this.uid++,selector:a,data:l},I[f.id]=f,g=q(this.indexes,a),m=0;m<g.length;m++)v=g[m],w=v.key,h=v.index,p=_(y,h),p||(p=Object.create(h),p.map=new O,y.push(p)),h===this.indexes.default&&this.logDefaultIndexUsed(f),S=p.map.get(w),S||(S=[],p.map.set(w,S)),S.push(f);this.size++,b.push(a)}},r.prototype.remove=function(a,l){if(typeof a=="string"){var f,m,h,w,p,S,g,v,y=this.activeIndexes,b=this.selectors=[],I=this.selectorObjects,N={},T=arguments.length===1;for(f=q(this.indexes,a),h=0;h<f.length;h++)for(m=f[h],w=y.length;w--;)if(S=y[w],m.index.isPrototypeOf(S)){if(g=S.map.get(m.key),g)for(p=g.length;p--;)v=g[p],v.selector===a&&(T||v.data===l)&&(g.splice(p,1),N[v.id]=!0);break}for(h in N)delete I[h],this.size--;for(h in I)b.push(I[h].selector)}};function E(a,l){return a.id-l.id}return r.prototype.queryAll=function(a){if(!this.selectors.length)return[];var l={},f=[],m=this.querySelectorAll(this.selectors.join(", "),a),h,w,p,S,g,v,y,b;for(h=0,p=m.length;h<p;h++)for(g=m[h],v=this.matches(g),w=0,S=v.length;w<S;w++)b=v[w],l[b.id]?y=l[b.id]:(y={id:b.id,selector:b.selector,data:b.data,elements:[]},l[b.id]=y,f.push(y)),y.elements.push(g);return f.sort(E)},r.prototype.matches=function(a){if(!a)return[];var l,f,m,h,w,p,S,g,v,y,b,I=this.activeIndexes,N={},T=[];for(l=0,h=I.length;l<h;l++)if(S=I[l],g=S.element(a),g){for(f=0,w=g.length;f<w;f++)if(v=S.map.get(g[f]))for(m=0,p=v.length;m<p;m++)y=v[m],b=y.id,!N[b]&&this.matchesSelector(a,y.selector)&&(N[b]=!0,T.push(y))}return T.sort(E)},r})});var te=J((B,ee)=>{(function(r,s){typeof B=="object"&&typeof ee!="undefined"?s(B,z()):typeof define=="function"&&define.amd?define(["exports","selector-set"],s):s(r.SelectorObserver={},r.SelectorSet)})(B,function(r,s){"use strict";s=s&&s.hasOwnProperty("default")?s.default:s;var d=null,x=null,A=[];function C(e,t){var n=[];function o(){var c=n;n=[],t(c)}function i(){for(var c=arguments.length,u=Array(c),M=0;M<c;M++)u[M]=arguments[M];n.push(u),n.length===1&&O(e,o)}return i}function O(e,t){x||(x=new MutationObserver(D)),d||(d=e.createElement("div"),x.observe(d,{attributes:!0})),A.push(t),d.setAttribute("data-twiddle",""+Date.now())}function D(){var e=A;A=[];for(var t=0;t<e.length;t++)try{e[t]()}catch(n){setTimeout(function(){throw n},0)}}var q=new WeakMap,_=new WeakMap,E=new WeakMap,a=new WeakMap;function l(e,t){for(var n=0;n<t.length;n++){var o=t[n],i=o[0],c=o[1],u=o[2];i===v?(f(u,c),m(u,c)):i===y?h(u,c):i===b&&w(e.observers,c)}}function f(e,t){if(t instanceof e.elementConstructor){var n=q.get(t);if(n||(n=[],q.set(t,n)),n.indexOf(e.id)===-1){var o=void 0;if(e.initialize&&(o=e.initialize.call(void 0,t)),o){var i=_.get(t);i||(i={},_.set(t,i)),i[""+e.id]=o}n.push(e.id)}}}function m(e,t){if(t instanceof e.elementConstructor){var n=a.get(t);if(n||(n=[],a.set(t,n)),n.indexOf(e.id)===-1){e.elements.push(t);var o=_.get(t),i=o?o[""+e.id]:null;if(i&&i.add&&i.add.call(void 0,t),e.subscribe){var c=e.subscribe.call(void 0,t);if(c){var u=E.get(t);u||(u={},E.set(t,u)),u[""+e.id]=c}}e.add&&e.add.call(void 0,t),n.push(e.id)}}}function h(e,t){if(t instanceof e.elementConstructor){var n=a.get(t);if(!!n){var o=e.elements.indexOf(t);if(o!==-1&&e.elements.splice(o,1),o=n.indexOf(e.id),o!==-1){var i=_.get(t),c=i?i[""+e.id]:null;if(c&&c.remove&&c.remove.call(void 0,t),e.subscribe){var u=E.get(t),M=u?u[""+e.id]:null;M&&M.unsubscribe&&M.unsubscribe()}e.remove&&e.remove.call(void 0,t),n.splice(o,1)}n.length===0&&a.delete(t)}}}function w(e,t){var n=a.get(t);if(!!n){for(var o=n.slice(0),i=0;i<o.length;i++){var c=e[o[i]];if(!!c){var u=c.elements.indexOf(t);u!==-1&&c.elements.splice(u,1);var M=_.get(t),k=M?M[""+c.id]:null;k&&k.remove&&k.remove.call(void 0,t);var R=E.get(t),j=R?R[""+c.id]:null;j&&j.unsubscribe&&j.unsubscribe(),c.remove&&c.remove.call(void 0,t)}}a.delete(t)}}var p=null;function S(e){if(p===null){var t=e.createElement("div"),n=e.createElement("div"),o=e.createElement("div");t.appendChild(n),n.appendChild(o),t.innerHTML="",p=o.parentNode!==n}return p}function g(e){return"matches"in e||"webkitMatchesSelector"in e||"mozMatchesSelector"in e||"oMatchesSelector"in e||"msMatchesSelector"in e}var v=1,y=2,b=3;function I(e,t,n){for(var o=0;o<n.length;o++){var i=n[o];i.type==="childList"?(N(e,t,i.addedNodes),T(e,t,i.removedNodes)):i.type==="attributes"&&P(e,t,i.target)}S(e.ownerDocument)&&se(e,t)}function N(e,t,n){for(var o=0;o<n.length;o++){var i=n[o];if(g(i))for(var c=e.selectorSet.matches(i),u=0;u<c.length;u++){var M=c[u].data;t.push([v,i,M])}if("querySelectorAll"in i)for(var k=e.selectorSet.queryAll(i),R=0;R<k.length;R++)for(var j=k[R],ye=j.data,Q=j.elements,$=0;$<Q.length;$++)t.push([v,Q[$],ye])}}function T(e,t,n){for(var o=0;o<n.length;o++){var i=n[o];if("querySelectorAll"in i){t.push([b,i]);for(var c=i.querySelectorAll("*"),u=0;u<c.length;u++)t.push([b,c[u]])}}}function P(e,t,n){if(g(n))for(var o=e.selectorSet.matches(n),i=0;i<o.length;i++){var c=o[i].data;t.push([v,n,c])}if("querySelectorAll"in n){var u=a.get(n);if(u)for(var M=0;M<u.length;M++){var k=e.observers[u[M]];k&&(e.selectorSet.matchesSelector(n,k.selector)||t.push([y,n,k]))}}}function oe(e,t,n){if("querySelectorAll"in n){P(e,t,n);for(var o=n.querySelectorAll("*"),i=0;i<o.length;i++)P(e,t,o[i])}}function ae(e,t,n){for(var o=0;o<n.length;o++)for(var i=n[o],c=i.form?i.form.elements:e.rootNode.querySelectorAll("input"),u=0;u<c.length;u++)P(e,t,c[u])}function se(e,t){for(var n=0;n<e.observers.length;n++){var o=e.observers[n];if(o)for(var i=o.elements,c=0;c<i.length;c++){var u=i[c];u.parentNode||t.push([b,u])}}}function le(e,t){var n=e.readyState;n==="interactive"||n==="complete"?O(e,t):e.addEventListener("DOMContentLoaded",O(e,t))}var fe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ce=0;function F(e){this.rootNode=e.nodeType===9?e.documentElement:e,this.ownerDocument=e.nodeType===9?e:e.ownerDocument,this.observers=[],this.selectorSet=new s,this.mutationObserver=new MutationObserver(he.bind(this,this)),this._scheduleAddRootNodes=C(this.ownerDocument,de.bind(this,this)),this._handleThrottledChangedTargets=C(this.ownerDocument,pe.bind(this,this)),this.rootNode.addEventListener("change",me.bind(this,this),!1),le(this.ownerDocument,ue.bind(this,this))}F.prototype.disconnect=function(){this.mutationObserver.disconnect()},F.prototype.observe=function(e,t){var n=void 0;typeof t=="function"?n={selector:e,initialize:t}:(typeof t=="undefined"?"undefined":fe(t))==="object"?(n=t,n.selector=e):n=e;var o=this,i={id:ce++,selector:n.selector,initialize:n.initialize,add:n.add,remove:n.remove,subscribe:n.subscribe,elements:[],elementConstructor:n.hasOwnProperty("constructor")?n.constructor:this.ownerDocument.defaultView.Element,abort:function(){o._abortObserving(i)}};return this.selectorSet.add(i.selector,i),this.observers[i.id]=i,this._scheduleAddRootNodes(),i},F.prototype._abortObserving=function(e){for(var t=e.elements,n=0;n<t.length;n++)h(e,t[n]);this.selectorSet.remove(e.selector,e),delete this.observers[e.id]},F.prototype.triggerObservers=function(e){var t=[];oe(this,t,e),l(this,t)};function ue(e){e.mutationObserver.observe(e.rootNode,{childList:!0,attributes:!0,subtree:!0}),e._scheduleAddRootNodes()}function de(e){var t=[];N(e,t,[e.rootNode]),l(e,t)}function he(e,t){var n=[];I(e,n,t),l(e,n)}function me(e,t){e._handleThrottledChangedTargets(t.target)}function pe(e,t){var n=[];ae(e,n,t),l(e,n)}var G=void 0;function H(){return G||(G=new F(window.document)),G}function ve(){var e;return(e=H()).observe.apply(e,arguments)}function ge(){var e;return(e=H()).triggerObservers.apply(e,arguments)}r.getDocumentObserver=H,r.observe=ve,r.triggerObservers=ge,r.default=F,Object.defineProperty(r,"__esModule",{value:!0})})});var Ie=["a","altGlyph","altGlyphDef","altGlyphItem","animate","animateColor","animateMotion","animateTransform","animation","audio","canvas","circle","clipPath","color-profile","cursor","defs","desc","discard","ellipse","feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feDropShadow","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feImage","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence","filter","font","font-face","font-face-format","font-face-name","font-face-src","font-face-uri","foreignObject","g","glyph","glyphRef","handler","hkern","iframe","image","line","linearGradient","listener","marker","mask","metadata","missing-glyph","mpath","path","pattern","polygon","polyline","prefetch","radialGradient","rect","script","set","solidColor","stop","style","svg","switch","symbol","tbreak","text","textArea","textPath","title","tref","tspan","unknown","use","video","view","vkern"],L=new Set(Ie);L.delete("a");L.delete("audio");L.delete("canvas");L.delete("iframe");L.delete("script");L.delete("video");var ke=/acit|ex(?:s|g|n|p|$)|rph|ows|mnc|ntw|ine[ch]|zoo|^ord/i,De=r=>r===DocumentFragment,Ne=(r,s)=>{for(let[d,x]of Object.entries(s))d.startsWith("-")?r.style.setProperty(d,x):typeof x=="number"&&!ke.test(d)?r.style[d]=`${x}px`:r.style[d]=x},_e=r=>typeof r=="string"?L.has(r)?document.createElementNS("http://www.w3.org/2000/svg",r):document.createElement(r):De(r)?document.createDocumentFragment():r(r.defaultProps),K=(r,s,d)=>{d!=null&&(/^xlink[AHRST]/.test(s)?r.setAttributeNS("http://www.w3.org/1999/xlink",s.replace("xlink","xlink:").toLowerCase(),d):r.setAttribute(s,d))},X=(r,s)=>{for(let d of s)d instanceof Node?r.appendChild(d):Array.isArray(d)?X(r,d):typeof d!="boolean"&&typeof d!="undefined"&&d!==null&&r.appendChild(document.createTextNode(d))},Ee=(r,s,...d)=>{var x;let A=_e(r);if(X(A,d),A instanceof DocumentFragment||!s)return A;for(let[C,O]of Object.entries(s))if(C==="htmlFor"&&(C="for"),C==="class"||C==="className"){let D=(x=A.getAttribute("class"))!==null&&x!==void 0?x:"";K(A,"class",(D+" "+String(O)).trim())}else if(C==="style")Ne(A,O);else if(C.startsWith("on")){let D=C.slice(2).toLowerCase().replace(/^-/,"");A.addEventListener(D,O)}else C==="dangerouslySetInnerHTML"&&"__html"in O?A.innerHTML=O.__html:C!=="key"&&O!==!1&&K(A,C,O===!0?"":O);return A},Le=typeof DocumentFragment=="function"?DocumentFragment:()=>{},Te={createElement:Ee,Fragment:Le},Y=Te;var ne=Ce(te()),Fe=r=>r.style.backgroundImage.replace(/^url\("(.+)"\)$/,"$1"),V=".link_preview_right_image, .tgme_widget_message_reply_thumb",re=`.link_preview_image, ${V}`,ie="trm-processed";GM.addStyle(`
/* Remove the cover on videos */
.link_preview_video_player:after {
    display: none;
}

/* Fix thumb size */
${V} {
    object-fit: cover;
}
`);(0,ne.observe)(`:is(.tgme_widget_message_photo, ${re}):not(.${ie})`,{add(r){let s=r.matches(re)?r:r.closest(".tgme_widget_message_photo_wrap");if(!s)return;let d=Y.createElement("img",{className:r.className,src:Fe(s)});d.classList.add(ie),r.matches(V)||(d.style.width="100%"),r.replaceWith(d)}});})();
